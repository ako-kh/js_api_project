<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-primary mb-5">
        <div class="container-fluid" id="mynavbar">
            <a class="navbar-brand" href="#">Store</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" href="index.html">Home</a>
                    <a class="nav-link" href="cart.html">Cart</a>
                </div>
            </div>
        </div>    
    </nav>

    <div class="container" id="main_container">
        <div class="row">
            <div class="col-8 flex-column" id="items"></div>

            <div class="col-4 " id="buy">
                <h3 class="h3">Total: $<span id="total"></span></h3>
                <h5 class="h5">Quantity of items: <span id="quantity"></span></h5>
                <button class="btn btn-success" id="buy">buy now</button>
            </div>

        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        axios.get("https://api.everrest.educata.dev/shop/cart",
            HEADERS
        ).then(function(response){
            let total_quantity = response.data.total.quantity
            //let total_price = response.data.total.price.current
            let total = response.data.total
            if (total_quantity == 0){
                let main_container = document.getElementById("main_container")
                main_container.innerHTML = ""
                main_container.innerHTML = "<h1 class='h1 text-center'>Cart is empty</h1>"
            }

            let total_price_span = document.getElementById("total")
            let quantity_span = document.getElementById("quantity")
            total_price_span.textContent = total.price.current
            quantity_span.textContent = total_quantity

            response.data.products.forEach(function(product){
                console.log(product)
                axios.get("https://api.everrest.educata.dev/shop/products/id/" + product.productId).then(function(response1){
                    console.log(response1.data)
                    let row = document.createElement("div")
                    row.className = "d-flex mb-3"

                    let img = document.createElement("img")
                    img.src = response1.data.thumbnail
                    img.style.height = "100px"
                    img.style.objectFit = "contain"

                    let title = document.createElement("h5")
                    title.textContent = response1.data.title

                    let price = document.createElement("p")
                    price.textContent = "$" + response1.data.price.current

                    let text_div = document.createElement("div")
                    text_div.appendChild(title)
                    text_div.appendChild(price)
                    //text_div.appendChild(quantity)

                    //let n_input = document.createElement("input")
                    //n_input.type = "number"
                   // n_input.defaultValue = "1"

                    let quantity_n = product.quantity
                    let quantity = document.createElement("p")
                    quantity.textContent = "quantity: " + quantity_n

                    let decrease = document.createElement("button")
                    decrease.className = "btn"
                    decrease.textContent = "-"
                    decrease.onclick = function(){
                        if (quantity_n > 1){
                            axios.patch("https://api.everrest.educata.dev/shop/cart/product",{
                                id: product.productId,
                                quantity: quantity_n -1
                            }, HEADERS).then(function(btn_response){
                                console.log(btn_response)
                                quantity.textContent = "quantity: " + (quantity_n - 1)
                                quantity_n -= 1
                                total_price_span.textContent = btn_response.data.total.price.current
                                quantity_span.textContent = btn_response.data.total.quantity
                            }).catch(function(error){
                                console.log(error)
                            })
                        }
                    }

                    let increase = document.createElement("button")
                    increase.className = "btn"
                    increase.textContent = "+"
                    increase.onclick = function(){
                        axios.patch("https://api.everrest.educata.dev/shop/cart/product",{
                                id: product.productId,
                                quantity: quantity_n + 1
                            }, HEADERS).then(function(btn_response){
                                quantity.textContent = "quantity: " + (quantity_n + 1)
                                quantity_n += 1
                                total_price_span.textContent = btn_response.data.total.price.current
                                quantity_span.textContent = btn_response.data.total.quantity
                            }).catch(function(error){
                                console.log(error)
                            })
                    }

                    let control_div = document.createElement("div")
                    control_div.className = "flex-fill d-flex justify-content-end align-items-center"
                    //control_div.appendChild(n_input)
                    control_div.appendChild(quantity)
                    control_div.appendChild(decrease)
                    control_div.appendChild(increase)

                    let delete_btn = document.createElement("button")
                    delete_btn.className = "btn btn-danger"
                    delete_btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/> <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/> </svg>'
                    delete_btn.onclick = function(){
                        axios.delete("https://api.everrest.educata.dev/shop/cart/product", {
                            headers: {
                                "Authorization": "Bearer " + window.localStorage.getItem("access_token")
                            },
                            data: {
                                id: product.productId
                            }
                        }).then(function(response){
                            window.location.reload()
                        }).catch(function(error){
                            console.log(error)
                        })
                    }
                    control_div.appendChild(delete_btn)

                    row.appendChild(img)
                    row.appendChild(text_div)
                    row.appendChild(control_div)
                    

                    let items = document.getElementById("items")
                    items.appendChild(row)

                }).catch(function(error){
                    console.log(error)
                })
            })


        }).catch(function(error){
            console.log(error)
            let main_container = document.getElementById("main_container")
            main_container.innerHTML = ""
            main_container.innerHTML = "<h1 class='h1 text-center'>Cart is empty</h1>"
        })
        document.getElementById("buy").onclick = function(){
            axios.post("https://api.everrest.educata.dev/shop/cart/checkout", {}, HEADERS).then(function(response){
                alert("purchase successful")
                window.location.reload()
            }).catch(function(error){
                console.log(error)
            })
        }
    </script>
</body>
</html>