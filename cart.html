<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-8 flex-column" id="items"></div>

            <div class="col-4 " id="buy">
                <h3 class="h3">Total: $<span id="total"></span></h3>
                <h5 class="h5">Quantity of items: <span id="quantity"></span></h5>
                <button class="btn btn-success" id="buy">buy now</button>
            </div>

        </div>
    </div>
    
    <script>
        axios.get("https://api.everrest.educata.dev/shop/cart", {
            headers: {
                "Authorization": "Bearer " + window.localStorage.getItem("access_token")
            }
        }).then(function(response){
            console.log(response)
            let total = response.data.total
            response.data.products.forEach(function(product){
                console.log(product)
                axios.get("https://api.everrest.educata.dev/shop/products/id/" + product.productId).then(function(response1){
                    console.log(response1.data)
                    let row = document.createElement("div")
                    row.className = "d-flex mb-3"

                    let img = document.createElement("img")
                    img.src = response1.data.thumbnail
                    img.style.height = "100px"
                    img.style.objectFit = "contain"

                    let title = document.createElement("h5")
                    title.textContent = response1.data.title

                    let price = document.createElement("p")
                    price.textContent = "$" + response1.data.price.current

                    let quantity = document.createElement("p")
                    quantity.textContent = "quantity: " + product.quantity


                    let text_div = document.createElement("div")
                    text_div.appendChild(title)
                    text_div.appendChild(price)
                    text_div.appendChild(quantity)

                    let n_input = document.createElement("input")
                    n_input.type = "number"
                    n_input.defaultValue = "1"
                    
                    let increase = document.createElement("button")
                    increase.className = "btn btn-primary"
                    increase.textContent = "+"
                    increase.onclick = function(){
                        let n = parseInt(n_input.value)
                        if (n > 0) {
                            addToCart_f(product.productId, product.quantity + n)
                        }
                    }

                    let control_div = document.createElement("div")
                    control_div.className = "flex-fill d-flex justify-content-end align-items-center"
                    control_div.appendChild(n_input)
                    control_div.appendChild(increase)


                    row.appendChild(img)
                    row.appendChild(text_div)
                    row.appendChild(control_div)
                    

                    let items = document.getElementById("items")
                    items.appendChild(row)

                }).catch(function(error){
                    console.log(error)
                })
            })
            document.getElementById("total").textContent = total.price.current
            document.getElementById("quantity").textContent = total.quantity


        }).catch(function(error){
            console.log(error)
        })
        console.log(HEADERS)
        document.getElementById("buy").onclick = function(){
            axios.post("https://api.everrest.educata.dev/shop/cart/checkout", {}, HEADERS).then(function(response){
                alert("purchase successful")
                window.location.reload()
            }).catch(function(error){
                console.log(error)
            })
        }
    </script>
</body>
</html>